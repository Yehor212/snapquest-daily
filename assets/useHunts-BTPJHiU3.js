import{_ as i,v as a,$ as l,a0 as f,a1 as d}from"./index-DFnNWw_v.js";async function _(){if(!i)return[];const{data:e,error:r}=await a.from("hunts").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(r)return console.error("Error fetching hunts:",r),[];if(!e||e.length===0)return[];const t=e.map(o=>o.id),{data:s}=await a.from("hunt_tasks").select("hunt_id").in("hunt_id",t),n={};return(s||[]).forEach(o=>{n[o.hunt_id]=(n[o.hunt_id]||0)+1}),e.map(o=>({...o,task_count:n[o.id]||0}))}async function h(e){if(!i)return null;const[r,t]=await Promise.all([a.from("hunts").select("*").eq("id",e).single(),a.from("hunt_tasks").select("*").eq("hunt_id",e).order("order_num")]);return r.error||!r.data?(console.error("Error fetching hunt:",r.error),null):{hunt:r.data,tasks:t.data||[]}}async function g(e){if(!i)return null;const{data:{user:r}}=await a.auth.getUser();if(!r)return null;const{data:t,error:s}=await a.from("hunt_progress").select("*").eq("hunt_id",e).eq("user_id",r.id).single();return s&&s.code!=="PGRST116"&&console.error("Error fetching hunt progress:",s),t}async function y(e){if(!i)return null;const{data:{user:r}}=await a.auth.getUser();if(!r)return null;const{data:t,error:s}=await a.from("hunt_progress").insert({hunt_id:e,user_id:r.id,completed_tasks:[],total_xp_earned:0}).select().single();return s?(console.error("Error starting hunt:",s),null):t}async function p(e,r,t){if(!i)return null;const{data:{user:s}}=await a.auth.getUser();if(!s)return null;let n=await g(e);if(n||(n=await y(e)),!n)return null;if(n.completed_tasks.includes(r))return n;const{data:o,error:c}=await a.from("hunt_progress").update({completed_tasks:[...n.completed_tasks,r],total_xp_earned:n.total_xp_earned+t}).eq("id",n.id).select().single();return c?(console.error("Error completing task:",c),null):o}async function m(){if(!i)return[];const{data:{user:e}}=await a.auth.getUser();if(!e)return[];const{data:r,error:t}=await a.from("hunt_progress").select("*").eq("user_id",e.id);return t?(console.error("Error fetching hunt progress:",t),[]):r||[]}const u={all:["hunts"],active:()=>[...u.all,"active"],detail:e=>[...u.all,"detail",e],progress:e=>[...u.all,"progress",e],userProgress:()=>[...u.all,"userProgress"]};function k(){return l({queryKey:u.active(),queryFn:_,staleTime:10*60*1e3})}function w(e){return l({queryKey:u.detail(e||""),queryFn:()=>h(e),enabled:!!e,staleTime:10*60*1e3})}function H(e){return l({queryKey:u.progress(e||""),queryFn:()=>g(e),enabled:!!e,staleTime:60*1e3})}function P(){return l({queryKey:u.userProgress(),queryFn:m,staleTime:5*60*1e3})}function v(){const e=f();return d({mutationFn:r=>y(r),onSuccess:(r,t)=>{r&&(e.setQueryData(u.progress(t),r),e.invalidateQueries({queryKey:u.userProgress()}))}})}function T(){const e=f();return d({mutationFn:({huntId:r,taskId:t,xpReward:s})=>p(r,t,s),onSuccess:(r,{huntId:t})=>{r&&(e.setQueryData(u.progress(t),r),e.invalidateQueries({queryKey:u.userProgress()}),e.invalidateQueries({queryKey:["profile"]}))}})}export{w as a,k as b,P as c,H as d,v as e,T as u};
