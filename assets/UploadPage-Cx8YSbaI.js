import{c as U,r as d,j as e,B as P,C as W,I as fe,m as D,a as oe,X as Ue,b as Ye,d as qe,u as Ge,e as O,f as Y,g as We,P as Z,h as Ze,T as Je,i as Qe,k as ae,l as re,n as et,o as tt,p as st,q as nt,s as at,t as rt,v as it,w as ot,L as H,x as he,S as ie,y as ct}from"./index-X3YY-C0S.js";import{u as lt,c as we}from"./index-ODAm_FIq.js";import{X as J}from"./XpBadge-C-Cp13ih.js";import{u as dt,a as mt}from"./useHunts-fygRLs0X.js";import{A as xe}from"./arrow-left-CtnlzYUZ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=U("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=U("CircleX",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=U("Contrast",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 18a6 6 0 0 0 0-12v12z",key:"j4l70d"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xt=U("Droplets",[["path",{d:"M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",key:"1ptgy4"}],["path",{d:"M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",key:"1sl1rz"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=U("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=U("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]]),Q={none:"none",grayscale:"grayscale(100%)",sepia:"sepia(100%)",vintage:"sepia(50%) contrast(90%) brightness(90%)",warm:"saturate(150%) hue-rotate(-10deg) brightness(105%)",cool:"saturate(90%) hue-rotate(10deg) brightness(95%)",dramatic:"contrast(130%) saturate(120%) brightness(90%)",fade:"contrast(90%) brightness(110%) saturate(80%)"},ge={none:"Оригинал",grayscale:"Ч/Б",sepia:"Сепия",vintage:"Винтаж",warm:"Тёплый",cool:"Холодный",dramatic:"Драма",fade:"Выцветший"};async function vt(n,s){return new Promise((r,i)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const o=document.createElement("canvas"),t=o.getContext("2d");if(!t){i(new Error("Could not get canvas context"));return}o.width=a.width,o.height=a.height,t.filter=Q[s],t.drawImage(a,0,0),r(o.toDataURL("image/jpeg",.9))},a.onerror=()=>i(new Error("Failed to load image")),a.src=n})}async function yt(n,s){return new Promise((r,i)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const o=document.createElement("canvas"),t=o.getContext("2d");if(!t){i(new Error("Could not get canvas context"));return}o.width=s.width,o.height=s.height,t.drawImage(a,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r(o.toDataURL("image/jpeg",.9))},a.onerror=()=>i(new Error("Failed to load image")),a.src=n})}async function wt(n,s=1920,r=.8){return new Promise((i,a)=>{const o=new FileReader;o.onload=t=>{var m;const c=new Image;c.onload=()=>{const u=document.createElement("canvas"),b=u.getContext("2d");if(!b){a(new Error("Could not get canvas context"));return}let{width:l,height:h}=c;l>s&&(h=h*s/l,l=s),u.width=l,u.height=h,b.drawImage(c,0,0,l,h),i(u.toDataURL("image/jpeg",r))},c.onerror=()=>a(new Error("Failed to load image")),c.src=(m=t.target)==null?void 0:m.result},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(n)})}async function pe(n,s){const i=await(await fetch(n)).blob();return new File([i],s,{type:i.type||"image/jpeg"})}async function bt(n,s=100,r=100,i=100){return new Promise((a,o)=>{const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{const c=document.createElement("canvas"),m=c.getContext("2d");if(!m){o(new Error("Could not get canvas context"));return}c.width=t.width,c.height=t.height,m.filter=`brightness(${s}%) contrast(${r}%) saturate(${i}%)`,m.drawImage(t,0,0),a(c.toDataURL("image/jpeg",.9))},t.onerror=()=>o(new Error("Failed to load image")),t.src=n})}function jt(n){return new Promise((s,r)=>{const i=new Image;i.onload=()=>s({width:i.width,height:i.height}),i.onerror=()=>r(new Error("Failed to load image")),i.src=n})}function Nt({onPhotoSelected:n,variant:s="default",disabled:r=!1}){const i=d.useRef(null),a=d.useRef(null),o=async t=>{var m;const c=(m=t.target.files)==null?void 0:m[0];if(c)try{const u=await wt(c,1920,.85);n(u)}catch(u){console.error("Error processing image:",u)}t.target.value=""};return s==="compact"?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:a,onChange:o,className:"hidden"}),e.jsx("input",{type:"file",accept:"image/*",ref:i,onChange:o,className:"hidden"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{variant:"outline",size:"icon",onClick:()=>{var t;return(t=a.current)==null?void 0:t.click()},disabled:r,children:e.jsx(W,{className:"w-5 h-5"})}),e.jsx(P,{variant:"outline",size:"icon",onClick:()=>{var t;return(t=i.current)==null?void 0:t.click()},disabled:r,children:e.jsx(fe,{className:"w-5 h-5"})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:a,onChange:o,className:"hidden"}),e.jsx("input",{type:"file",accept:"image/*",ref:i,onChange:o,className:"hidden"}),e.jsxs(D.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex flex-col gap-4 w-full max-w-sm",children:[e.jsxs(P,{size:"lg",className:"h-14 gap-3 bg-gradient-to-r from-primary to-primary/80",onClick:()=>{var t;return(t=a.current)==null?void 0:t.click()},disabled:r,children:[e.jsx(W,{className:"w-6 h-6"}),e.jsx("span",{className:"text-lg",children:"Сделать фото"})]}),e.jsxs(P,{size:"lg",variant:"outline",className:"h-14 gap-3",onClick:()=>{var t;return(t=i.current)==null?void 0:t.click()},disabled:r,children:[e.jsx(fe,{className:"w-6 h-6"}),e.jsx("span",{className:"text-lg",children:"Выбрать из галереи"})]})]})]})}const ve=["none","grayscale","sepia","vintage","warm","cool","dramatic","fade"];function St({imageUrl:n,selectedFilter:s,onFilterSelect:r}){const[i,a]=d.useState({});return d.useEffect(()=>{n&&(async()=>{const t={};for(const c of ve)t[c]=n;a(t)})()},[n]),e.jsxs("div",{className:"w-full",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Фильтры"}),e.jsx("div",{className:"flex gap-3 overflow-x-auto pb-2 scrollbar-hide",children:ve.map((o,t)=>e.jsxs(D.button,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:t*.05},onClick:()=>r(o),className:oe("flex-shrink-0 flex flex-col items-center gap-2 p-1 rounded-lg transition-all",s===o?"ring-2 ring-primary ring-offset-2 ring-offset-background":"hover:bg-secondary"),children:[e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden bg-secondary",style:{filter:Q[o]},children:e.jsx("img",{src:i[o]||n,alt:ge[o],className:"w-full h-full object-cover"})}),e.jsx("span",{className:oe("text-xs",s===o?"text-primary font-medium":"text-muted-foreground"),children:ge[o]})]},o))})]})}function kt({imageUrl:n,filter:s="none",adjustments:r,onRemove:i,onReset:a,showControls:o=!0}){const t=(r==null?void 0:r.brightness)??100,c=(r==null?void 0:r.contrast)??100,m=(r==null?void 0:r.saturation)??100,u=Q[s],b=`brightness(${t}%) contrast(${c}%) saturate(${m}%)`,l=u!=="none"?`${u} ${b}`:b;return e.jsxs(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative w-full aspect-square max-w-md mx-auto rounded-2xl overflow-hidden bg-secondary",children:[e.jsx("img",{src:n,alt:"Preview",className:"w-full h-full object-cover",style:{filter:l}}),o&&e.jsxs("div",{className:"absolute top-3 right-3 flex gap-2",children:[a&&e.jsx(P,{size:"icon",variant:"secondary",className:"w-10 h-10 rounded-full bg-black/50 hover:bg-black/70 backdrop-blur-sm",onClick:a,children:e.jsx(gt,{className:"w-5 h-5"})}),i&&e.jsx(P,{size:"icon",variant:"secondary",className:"w-10 h-10 rounded-full bg-black/50 hover:bg-black/70 backdrop-blur-sm",onClick:i,children:e.jsx(Ue,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"})]})}var be=["PageUp","PageDown"],je=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Ne={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},q="Slider",[ce,Ct,Et]=Ye(q),[Se,ss]=qe(q,[Et]),[It,ee]=Se(q),ke=d.forwardRef((n,s)=>{const{name:r,min:i=0,max:a=100,step:o=1,orientation:t="horizontal",disabled:c=!1,minStepsBetweenThumbs:m=0,defaultValue:u=[i],value:b,onValueChange:l=()=>{},onValueCommit:h=()=>{},inverted:N=!1,form:x,...y}=n,w=d.useRef(new Set),p=d.useRef(0),k=t==="horizontal"?Pt:Mt,[S=[],_]=Ge({prop:b,defaultProp:u,onChange:f=>{var R;(R=[...w.current][p.current])==null||R.focus(),l(f)}}),B=d.useRef(S);function g(f){const C=Dt(S,f);v(f,C)}function M(f){v(f,p.current)}function F(){const f=B.current[p.current];S[p.current]!==f&&h(S)}function v(f,C,{commit:R}={commit:!1}){const T=Lt(o),G=$t(Math.round((f-i)/o)*o+i,T),L=we(G,[i,a]);_(($=[])=>{const E=zt($,L,C);if(Vt(E,m*o)){p.current=E.indexOf(L);const X=String(E)!==String($);return X&&R&&h(E),X?E:$}else return $})}return e.jsx(It,{scope:n.__scopeSlider,name:r,disabled:c,min:i,max:a,valueIndexToChangeRef:p,thumbs:w.current,values:S,orientation:t,form:x,children:e.jsx(ce.Provider,{scope:n.__scopeSlider,children:e.jsx(ce.Slot,{scope:n.__scopeSlider,children:e.jsx(k,{"aria-disabled":c,"data-disabled":c?"":void 0,...y,ref:s,onPointerDown:O(y.onPointerDown,()=>{c||(B.current=S)}),min:i,max:a,inverted:N,onSlideStart:c?void 0:g,onSlideMove:c?void 0:M,onSlideEnd:c?void 0:F,onHomeKeyDown:()=>!c&&v(i,0,{commit:!0}),onEndKeyDown:()=>!c&&v(a,S.length-1,{commit:!0}),onStepKeyDown:({event:f,direction:C})=>{if(!c){const G=be.includes(f.key)||f.shiftKey&&je.includes(f.key)?10:1,L=p.current,$=S[L],E=o*G*C;v($+E,L,{commit:!0})}}})})})})});ke.displayName=q;var[Ce,Ee]=Se(q,{startEdge:"left",endEdge:"right",size:"width",direction:1}),Pt=d.forwardRef((n,s)=>{const{min:r,max:i,dir:a,inverted:o,onSlideStart:t,onSlideMove:c,onSlideEnd:m,onStepKeyDown:u,...b}=n,[l,h]=d.useState(null),N=Y(s,k=>h(k)),x=d.useRef(void 0),y=We(a),w=y==="ltr",p=w&&!o||!w&&o;function A(k){const S=x.current||l.getBoundingClientRect(),_=[0,S.width],g=me(_,p?[r,i]:[i,r]);return x.current=S,g(k-S.left)}return e.jsx(Ce,{scope:n.__scopeSlider,startEdge:p?"left":"right",endEdge:p?"right":"left",direction:p?1:-1,size:"width",children:e.jsx(Ie,{dir:y,"data-orientation":"horizontal",...b,ref:N,style:{...b.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:k=>{const S=A(k.clientX);t==null||t(S)},onSlideMove:k=>{const S=A(k.clientX);c==null||c(S)},onSlideEnd:()=>{x.current=void 0,m==null||m()},onStepKeyDown:k=>{const _=Ne[p?"from-left":"from-right"].includes(k.key);u==null||u({event:k,direction:_?-1:1})}})})}),Mt=d.forwardRef((n,s)=>{const{min:r,max:i,inverted:a,onSlideStart:o,onSlideMove:t,onSlideEnd:c,onStepKeyDown:m,...u}=n,b=d.useRef(null),l=Y(s,b),h=d.useRef(void 0),N=!a;function x(y){const w=h.current||b.current.getBoundingClientRect(),p=[0,w.height],k=me(p,N?[i,r]:[r,i]);return h.current=w,k(y-w.top)}return e.jsx(Ce,{scope:n.__scopeSlider,startEdge:N?"bottom":"top",endEdge:N?"top":"bottom",size:"height",direction:N?1:-1,children:e.jsx(Ie,{"data-orientation":"vertical",...u,ref:l,style:{...u.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:y=>{const w=x(y.clientY);o==null||o(w)},onSlideMove:y=>{const w=x(y.clientY);t==null||t(w)},onSlideEnd:()=>{h.current=void 0,c==null||c()},onStepKeyDown:y=>{const p=Ne[N?"from-bottom":"from-top"].includes(y.key);m==null||m({event:y,direction:p?-1:1})}})})}),Ie=d.forwardRef((n,s)=>{const{__scopeSlider:r,onSlideStart:i,onSlideMove:a,onSlideEnd:o,onHomeKeyDown:t,onEndKeyDown:c,onStepKeyDown:m,...u}=n,b=ee(q,r);return e.jsx(Z.span,{...u,ref:s,onKeyDown:O(n.onKeyDown,l=>{l.key==="Home"?(t(l),l.preventDefault()):l.key==="End"?(c(l),l.preventDefault()):be.concat(je).includes(l.key)&&(m(l),l.preventDefault())}),onPointerDown:O(n.onPointerDown,l=>{const h=l.target;h.setPointerCapture(l.pointerId),l.preventDefault(),b.thumbs.has(h)?h.focus():i(l)}),onPointerMove:O(n.onPointerMove,l=>{l.target.hasPointerCapture(l.pointerId)&&a(l)}),onPointerUp:O(n.onPointerUp,l=>{const h=l.target;h.hasPointerCapture(l.pointerId)&&(h.releasePointerCapture(l.pointerId),o(l))})})}),Pe="SliderTrack",Me=d.forwardRef((n,s)=>{const{__scopeSlider:r,...i}=n,a=ee(Pe,r);return e.jsx(Z.span,{"data-disabled":a.disabled?"":void 0,"data-orientation":a.orientation,...i,ref:s})});Me.displayName=Pe;var le="SliderRange",Re=d.forwardRef((n,s)=>{const{__scopeSlider:r,...i}=n,a=ee(le,r),o=Ee(le,r),t=d.useRef(null),c=Y(s,t),m=a.values.length,u=a.values.map(h=>_e(h,a.min,a.max)),b=m>1?Math.min(...u):0,l=100-Math.max(...u);return e.jsx(Z.span,{"data-orientation":a.orientation,"data-disabled":a.disabled?"":void 0,...i,ref:c,style:{...n.style,[o.startEdge]:b+"%",[o.endEdge]:l+"%"}})});Re.displayName=le;var de="SliderThumb",Te=d.forwardRef((n,s)=>{const r=Ct(n.__scopeSlider),[i,a]=d.useState(null),o=Y(s,c=>a(c)),t=d.useMemo(()=>i?r().findIndex(c=>c.ref.current===i):-1,[r,i]);return e.jsx(Rt,{...n,ref:o,index:t})}),Rt=d.forwardRef((n,s)=>{const{__scopeSlider:r,index:i,name:a,...o}=n,t=ee(de,r),c=Ee(de,r),[m,u]=d.useState(null),b=Y(s,A=>u(A)),l=m?t.form||!!m.closest("form"):!0,h=Ze(m),N=t.values[i],x=N===void 0?0:_e(N,t.min,t.max),y=_t(i,t.values.length),w=h==null?void 0:h[c.size],p=w?At(w,x,c.direction):0;return d.useEffect(()=>{if(m)return t.thumbs.add(m),()=>{t.thumbs.delete(m)}},[m,t.thumbs]),e.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[c.startEdge]:`calc(${x}% + ${p}px)`},children:[e.jsx(ce.ItemSlot,{scope:n.__scopeSlider,children:e.jsx(Z.span,{role:"slider","aria-label":n["aria-label"]||y,"aria-valuemin":t.min,"aria-valuenow":N,"aria-valuemax":t.max,"aria-orientation":t.orientation,"data-orientation":t.orientation,"data-disabled":t.disabled?"":void 0,tabIndex:t.disabled?void 0:0,...o,ref:b,style:N===void 0?{display:"none"}:n.style,onFocus:O(n.onFocus,()=>{t.valueIndexToChangeRef.current=i})})}),l&&e.jsx(ze,{name:a??(t.name?t.name+(t.values.length>1?"[]":""):void 0),form:t.form,value:N},i)]})});Te.displayName=de;var Tt="RadioBubbleInput",ze=d.forwardRef(({__scopeSlider:n,value:s,...r},i)=>{const a=d.useRef(null),o=Y(a,i),t=lt(s);return d.useEffect(()=>{const c=a.current;if(!c)return;const m=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(m,"value").set;if(t!==s&&b){const l=new Event("input",{bubbles:!0});b.call(c,s),c.dispatchEvent(l)}},[t,s]),e.jsx(Z.input,{style:{display:"none"},...r,ref:o,defaultValue:s})});ze.displayName=Tt;function zt(n=[],s,r){const i=[...n];return i[r]=s,i.sort((a,o)=>a-o)}function _e(n,s,r){const o=100/(r-s)*(n-s);return we(o,[0,100])}function _t(n,s){return s>2?`Value ${n+1} of ${s}`:s===2?["Minimum","Maximum"][n]:void 0}function Dt(n,s){if(n.length===1)return 0;const r=n.map(a=>Math.abs(a-s)),i=Math.min(...r);return r.indexOf(i)}function At(n,s,r){const i=n/2,o=me([0,50],[0,i]);return(i-o(s)*r)*r}function Ft(n){return n.slice(0,-1).map((s,r)=>n[r+1]-s)}function Vt(n,s){if(s>0){const r=Ft(n);return Math.min(...r)>=s}return!0}function me(n,s){return r=>{if(n[0]===n[1]||s[0]===s[1])return s[0];const i=(s[1]-s[0])/(n[1]-n[0]);return s[0]+i*(r-n[0])}}function Lt(n){return(String(n).split(".")[1]||"").length}function $t(n,s){const r=Math.pow(10,s);return Math.round(n*r)/r}var De=ke,Bt=Me,Kt=Re,Xt=Te;const K=d.forwardRef(({className:n,...s},r)=>e.jsxs(De,{ref:r,className:oe("relative flex w-full touch-none select-none items-center",n),...s,children:[e.jsx(Bt,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(Kt,{className:"absolute h-full bg-primary"})}),e.jsx(Xt,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));K.displayName=De.displayName;const ye={filter:"none",brightness:100,contrast:100,saturation:100},V={enabled:!1,zoom:100,offsetX:0,offsetY:0};function Ht({imageUrl:n,initialOptions:s,onSave:r,onCancel:i}){const[a,o]=d.useState({...ye,...s}),[t,c]=d.useState(V.enabled),[m,u]=d.useState(V.zoom),[b,l]=d.useState(V.offsetX),[h,N]=d.useState(V.offsetY),[x,y]=d.useState(null);d.useEffect(()=>{let g=!0;return jt(n).then(M=>{g&&y(M)}).catch(()=>{g&&y(null)}),()=>{g=!1}},[n]),d.useEffect(()=>{if(!x||!(s!=null&&s.crop))return;const g=Math.min(x.width,x.height),M=Math.max(1,s.crop.width),F=Math.round(g/M*100),v=(x.width-M)/2,f=(x.height-M)/2,C=v>0?Math.round((s.crop.x-v)/v*100):0,R=f>0?Math.round((s.crop.y-f)/f*100):0;c(!0),u(Math.max(100,Math.min(250,F))),l(Math.max(-100,Math.min(100,C))),N(Math.max(-100,Math.min(100,R)))},[x,s==null?void 0:s.crop]);const w=g=>{o(M=>({...M,filter:g}))},p=(g,M)=>{o(F=>({...F,[g]:M[0]}))},A=()=>{o(ye),c(V.enabled),u(V.zoom),l(V.offsetX),N(V.offsetY)},k=()=>{let g;if(t&&x){const M=m/100,F=Math.min(x.width,x.height),v=Math.min(F,Math.max(1,F/M)),f=(x.width-v)/2,C=(x.height-v)/2,R=f+f*(b/100),T=C+C*(h/100);g={x:Math.max(0,Math.min(x.width-v,Math.round(R))),y:Math.max(0,Math.min(x.height-v,Math.round(T))),width:Math.round(v),height:Math.round(v)}}r({...a,crop:g})},S=Q[a.filter],_=`brightness(${a.brightness}%) contrast(${a.contrast}%) saturate(${a.saturation}%)`,B=S!=="none"?`${S} ${_}`:_;return e.jsxs(D.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col h-full",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:e.jsx("div",{className:"relative w-full max-w-md aspect-square rounded-2xl overflow-hidden bg-secondary",children:e.jsx("img",{src:n,alt:"Edit preview",className:"w-full h-full object-cover",style:{filter:B}})})}),e.jsxs("div",{className:"bg-card border-t border-border p-4 space-y-4",children:[e.jsxs(Je,{defaultValue:"filters",className:"w-full",children:[e.jsxs(Qe,{className:"grid w-full grid-cols-3",children:[e.jsx(ae,{value:"filters",children:"Фильтры"}),e.jsx(ae,{value:"crop",children:"Обрезать"}),e.jsx(ae,{value:"adjust",children:"Настройки"})]}),e.jsx(re,{value:"filters",className:"mt-4",children:e.jsx(St,{imageUrl:n,selectedFilter:a.filter,onFilterSelect:w})}),e.jsxs(re,{value:"crop",className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Обрезка"}),e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>{t?(c(!1),u(V.zoom),l(V.offsetX),N(V.offsetY)):c(!0)},children:t?"Сбросить":"Включить"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-full max-w-xs aspect-square rounded-2xl overflow-hidden border border-border bg-secondary",children:[e.jsx("div",{className:"absolute inset-0",style:{backgroundImage:`url(${n})`,backgroundPosition:`${50+b/2}% ${50+h/2}%`,backgroundSize:t?`${m}%`:"contain",backgroundRepeat:"no-repeat",opacity:t?1:.8}}),!t&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-xs text-muted-foreground",children:"Обрезка выключена"})]})}),t&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Масштаб"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[m,"%"]})]}),e.jsx(K,{value:[m],min:100,max:250,step:1,onValueChange:g=>u(g[0])})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Смещение по X"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[b,"%"]})]}),e.jsx(K,{value:[b],min:-100,max:100,step:1,onValueChange:g=>l(g[0])})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Смещение по Y"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[h,"%"]})]}),e.jsx(K,{value:[h],min:-100,max:100,step:1,onValueChange:g=>N(g[0])})]})]})]}),e.jsxs(re,{value:"adjust",className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pt,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Яркость"})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[a.brightness,"%"]})]}),e.jsx(K,{value:[a.brightness],min:50,max:150,step:1,onValueChange:g=>p("brightness",g)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Контраст"})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[a.contrast,"%"]})]}),e.jsx(K,{value:[a.contrast],min:50,max:150,step:1,onValueChange:g=>p("contrast",g)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Насыщенность"})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[a.saturation,"%"]})]}),e.jsx(K,{value:[a.saturation],min:0,max:200,step:1,onValueChange:g=>p("saturation",g)})]}),e.jsx(P,{variant:"ghost",size:"sm",onClick:A,className:"w-full",children:"Сбросить настройки"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(P,{variant:"outline",className:"flex-1",onClick:i,children:"Отмена"}),e.jsx(P,{className:"flex-1",onClick:k,children:"Применить"})]})]})]})}const Ot="https://api-inference.huggingface.co/models/openai/clip-vit-base-patch32",Ut={"луч света":["light ray","sunbeam","light beam","sunlight through","ray of light","sun rays","light streaming"],закат:["sunset","golden hour","evening sky","orange sky","sun setting"],рассвет:["sunrise","dawn","morning light","early morning sky"],тень:["shadow","silhouette","dark shadow","shadows"],силуэт:["silhouette","dark figure","outline against light"],цветок:["flower","blossom","petal","bloom","floral"],дерево:["tree","trunk","branches","leaves","forest"],вода:["water","lake","river","ocean","pond","reflection in water"],облака:["clouds","sky","cloudy sky","cloud formation"],капля:["water drop","droplet","dew","rain drop"],архитектура:["architecture","building","facade","structure"],граффити:["graffiti","street art","mural","wall art"],улица:["street","road","urban","city street"],"ночной город":["night city","city lights","urban night","neon lights"],отражение:["reflection","mirror","reflected","glass reflection"],текстура:["texture","pattern","surface","material"],симметрия:["symmetry","symmetric","balanced","mirror image"],минимализм:["minimalist","simple","minimal","clean composition"],контраст:["contrast","light and dark","black and white"],кофе:["coffee","cup of coffee","coffee mug","latte"],книга:["book","reading","pages","literature"],еда:["food","meal","dish","cuisine"]};async function Yt(n){return new Promise((s,r)=>{const i=new FileReader;i.onload=()=>{const a=i.result.split(",")[1];s(a)},i.onerror=r,i.readAsDataURL(n)})}async function qt(n,s,r){const a=await fetch(Ot,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inputs:{image:n},parameters:{candidate_labels:s}})});if(!a.ok){const o=await a.text();throw new Error(`Hugging Face API error: ${o}`)}return a.json()}function Gt(n){const s=n.toLowerCase(),r=[];for(const[i,a]of Object.entries(Ut))s.includes(i)&&r.push(...a);if(r.length===0){const i=s.split(/\s+/).filter(a=>a.length>3);r.push(...i.slice(0,5))}return[...new Set(r)]}async function Wt(n,s,r,i){try{const a=`${s} ${r||""}`,o=Gt(a);if(o.length===0)return{isValid:!0,confidence:.5,matchedKeyword:null,allScores:[],message:"Не удалось определить ключевые слова. Фото принято."};const t=["random object","unrelated image","blank photo"],c=[...o.slice(0,8),...t],m=await Yt(n),u=await qt(m,c,i),l=u.filter(w=>!t.includes(w.label)).reduce((w,p)=>w.score>p.score?w:p,{label:"",score:0}),h=.15,N=.25;let x=!1,y="";return l.score>=N?(x=!0,y=`Отлично! Фото соответствует заданию (${Math.round(l.score*100)}% уверенность)`):l.score>=h?(x=!0,y=`Фото принято (${Math.round(l.score*100)}% соответствие)`):(x=!1,y=`Фото не соответствует заданию. Попробуйте сфотографировать: ${o.slice(0,3).join(", ")}`),{isValid:x,confidence:l.score,matchedKeyword:l.label,allScores:u,message:y}}catch(a){return console.error("Image verification error:",a),{isValid:!0,confidence:0,matchedKeyword:null,allScores:[],message:"Верификация недоступна. Фото принято."}}}function ns(){const n=et(),[s]=tt(),{toast:r}=st(),{user:i,isAuthenticated:a,loading:o}=nt(),{data:t,isLoading:c}=at(),m=rt(),u=it(),b=ot(),l=dt(),h=s.get("challengeId")||s.get("challenge")||(t==null?void 0:t.id),N=s.get("event"),x=s.get("eventChallenge"),y=s.get("huntId")||s.get("hunt"),w=s.get("huntTask"),p=s.get("challengeTitle"),A=s.get("xp")?parseInt(s.get("xp"),10):null,{data:k}=mt(y||void 0),[S,_]=d.useState(50),[B,g]=d.useState(null),[M,F]=d.useState(void 0);d.useEffect(()=>{(async()=>{if(x){const{data:j}=await ct.from("event_challenges").select("xp_reward, title, description").eq("id",x).single();j&&(_(j.xp_reward),g(j.title),F(j.description||void 0))}else if(w&&(k!=null&&k.tasks)){const j=k.tasks.find(I=>I.id===w);j&&(_(j.xp_reward),g(j.title),F(j.description||void 0))}else A?(_(A),g(p)):t!=null&&t.xp_reward&&(_(t.xp_reward),g(t.title),F(t.description||void 0))})()},[x,w,k,t,A,p]);const[v,f]=d.useState("select"),[C,R]=d.useState(null),[T,G]=d.useState({filter:"none",brightness:100,contrast:100,saturation:100}),[L,$]=d.useState(!1),[E,X]=d.useState(null),te=async(z,j)=>{let I=z;return j.crop&&(I=await yt(I,j.crop)),(j.brightness!==100||j.contrast!==100||j.saturation!==100)&&(I=await bt(I,j.brightness,j.contrast,j.saturation)),j.filter!=="none"&&(I=await vt(I,j.filter)),I},Ae=z=>{R(z),f("preview")},Fe=()=>{f("edit")},Ve=z=>{G(z),f("preview")},Le=()=>{f("preview")},$e=async()=>{if(C){f("verifying");try{const z=await te(C,T),j=await pe(z,"photo.jpg");let I={isValid:!0,confidence:1,matchedKeyword:null,allScores:[],message:"Фото принято"};const ue=B||(t==null?void 0:t.title)||p,Oe=M||(t==null?void 0:t.description);ue&&(I=await Wt(j,ue,Oe||void 0,void 0)),X(I),f("verified"),I.isValid&&await se(z)}catch(z){console.error("Verification error:",z),X({isValid:!0,confidence:0,matchedKeyword:null,allScores:[],message:"Верификация недоступна. Фото принято."}),f("verified");const j=await te(C,T);await se(j)}}},se=async z=>{if(!a||!i){r({title:"Требуется авторизация",description:"Войдите в аккаунт, чтобы загрузить фото",variant:"destructive"}),f("select"),$(!1);return}$(!0);try{const j=await pe(z,"photo.jpg"),I=await m.mutateAsync({file:j,options:{challengeId:h||void 0,eventId:N||void 0,eventChallengeId:x||void 0,huntId:y||void 0,huntTaskId:w||void 0,filter:T.filter!=="none"?T.filter:void 0,xpEarned:S}});if(!I||!I.id){console.error("Upload failed: no photo returned"),r({title:"Ошибка загрузки",description:"Не удалось сохранить фото в хранилище. Проверьте подключение.",variant:"destructive"}),f("preview");return}y&&w&&I.id?await l.mutateAsync({huntId:y,taskId:w,photoId:I.id}):(await u.mutateAsync(S),await b.mutateAsync()),f("success"),r({title:"Фото загружено!",description:`+${S} XP`}),setTimeout(()=>{n(y?`/hunts/${y}`:N?`/events/${N}`:"/gallery")},2e3)}catch(j){console.error("Error uploading photo:",j),r({title:"Ошибка",description:"Не удалось загрузить фото",variant:"destructive"}),f("preview")}finally{$(!1)}},Be=()=>{R(null),X(null),f("select")},Ke=async()=>{if(!C)return;const z=await te(C,T);await se(z)},Xe=()=>{v==="preview"?(R(null),f("select")):v==="edit"||v==="verified"&&!(E!=null&&E.isValid)?f("preview"):n(-1)},ne=S,He=(t==null?void 0:t.day_number)||1;return o?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(H,{className:"w-8 h-8 animate-spin text-primary"})}):a?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"sticky top-0 z-40 bg-background/80 backdrop-blur-lg border-b border-border",children:e.jsxs("div",{className:"container mx-auto px-4 h-16 flex items-center justify-between",children:[e.jsx(P,{variant:"ghost",size:"icon",onClick:Xe,children:e.jsx(xe,{className:"w-5 h-5"})}),e.jsxs("h1",{className:"font-display text-lg font-semibold",children:[v==="select"&&"Загрузить фото",v==="preview"&&"Предпросмотр",v==="edit"&&"Редактирование",v==="verifying"&&"Проверка фото...",v==="verified"&&(E!=null&&E.isValid?"Проверено!":"Не соответствует"),v==="success"&&"Готово!"]}),e.jsx("div",{className:"w-10"})]})}),e.jsxs("main",{className:"container mx-auto px-4 py-6",children:[v==="select"&&e.jsxs(D.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex flex-col items-center justify-center min-h-[60vh] gap-8",children:[c?e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(H,{className:"w-5 h-5 animate-spin"}),"Загрузка задания..."]}):t?e.jsxs("div",{className:"text-center max-w-sm",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-full bg-secondary border border-border mb-4",children:[e.jsx(W,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium",children:["День #",He]})]}),e.jsx("h2",{className:"font-display text-2xl font-bold mb-2",children:t.title}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4",children:t.description}),e.jsx(J,{xp:ne})]}):p?e.jsxs("div",{className:"text-center max-w-sm",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-full bg-secondary border border-border mb-4",children:[e.jsx(ie,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Генератор"})]}),e.jsx("h2",{className:"font-display text-2xl font-bold mb-2",children:p}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4",children:"Выполните сгенерированный челлендж"}),e.jsx(J,{xp:ne})]}):e.jsxs("div",{className:"text-center max-w-sm",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-full bg-secondary border border-border mb-4",children:[e.jsx(W,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Свободная тема"})]}),e.jsx("h2",{className:"font-display text-2xl font-bold mb-2",children:"Загрузите фото"}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4",children:"Поделитесь своим творчеством"}),e.jsx(J,{xp:50})]}),e.jsx(Nt,{onPhotoSelected:Ae})]}),v==="preview"&&C&&e.jsxs(D.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col gap-6",children:[e.jsx(kt,{imageUrl:C,filter:T.filter,adjustments:{brightness:T.brightness,contrast:T.contrast,saturation:T.saturation},onRemove:()=>{R(null),f("select")}}),e.jsxs("div",{className:"flex flex-col gap-3 max-w-md mx-auto w-full",children:[e.jsxs(P,{variant:"outline",size:"lg",onClick:Fe,className:"gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),"Редактировать"]}),e.jsx(P,{size:"lg",onClick:$e,disabled:L,className:"gap-2 bg-gradient-to-r from-primary to-primary/80",children:L?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-5 h-5 animate-spin"}),"Загрузка..."]}):"Проверить и отправить"})]})]}),v==="edit"&&C&&e.jsx("div",{className:"fixed inset-0 z-50 bg-background",children:e.jsx(Ht,{imageUrl:C,initialOptions:T,onSave:Ve,onCancel:Le})}),v==="verifying"&&e.jsxs(D.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center min-h-[60vh] gap-6 text-center",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-secondary flex items-center justify-center",children:e.jsx(H,{className:"w-10 h-10 animate-spin text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-xl font-bold mb-2",children:"AI проверяет фото"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Определяем соответствие заданию..."})]})]}),v==="verified"&&E&&e.jsx(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"flex flex-col items-center justify-center min-h-[60vh] gap-6 text-center",children:E.isValid?e.jsxs(e.Fragment,{children:[e.jsx(D.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:30},className:"w-20 h-20 rounded-full bg-success/20 flex items-center justify-center",children:e.jsx(ut,{className:"w-10 h-10 text-success"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-xl font-bold mb-2 text-success",children:"Фото соответствует!"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-xs",children:E.message}),E.confidence>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Уверенность: ",Math.round(E.confidence*100),"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(H,{className:"w-4 h-4 animate-spin"}),"Загружаем фото..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(D.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:30},className:"w-20 h-20 rounded-full bg-destructive/20 flex items-center justify-center",children:e.jsx(ft,{className:"w-10 h-10 text-destructive"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-xl font-bold mb-2 text-destructive",children:"Не соответствует заданию"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-xs",children:E.message})]}),e.jsxs("div",{className:"flex flex-col gap-3 w-full max-w-xs",children:[e.jsxs(P,{onClick:Be,variant:"outline",className:"gap-2",children:[e.jsx(W,{className:"w-4 h-4"}),"Сделать другое фото"]}),e.jsx(P,{onClick:Ke,variant:"ghost",size:"sm",className:"text-muted-foreground",disabled:L,children:L?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 mr-2 animate-spin"}),"Загрузка..."]}):"Загрузить всё равно"})]})]})}),v==="success"&&e.jsxs(D.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center justify-center min-h-[60vh] gap-6 text-center",children:[e.jsx(D.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:30,delay:.2},className:"w-24 h-24 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center",children:e.jsx(ie,{className:"w-12 h-12 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-2xl font-bold mb-2",children:"Отлично!"}),e.jsx("p",{className:"text-muted-foreground",children:"Ваше фото успешно загружено"})]}),e.jsx(J,{xp:ne,size:"lg",animated:!0})]})]})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"sticky top-0 z-40 bg-background/80 backdrop-blur-lg border-b border-border",children:e.jsxs("div",{className:"container mx-auto px-4 h-16 flex items-center justify-between",children:[e.jsx(P,{variant:"ghost",size:"icon",onClick:()=>n(-1),children:e.jsx(xe,{className:"w-5 h-5"})}),e.jsx("h1",{className:"font-display text-lg font-semibold",children:"Загрузить фото"}),e.jsx("div",{className:"w-10"})]})}),e.jsx("main",{className:"container mx-auto px-4 py-6",children:e.jsxs(D.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex flex-col items-center justify-center min-h-[60vh] gap-6 text-center",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-secondary flex items-center justify-center",children:e.jsx(he,{className:"w-10 h-10 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-display text-xl font-bold mb-2",children:"Войдите в аккаунт"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-xs",children:"Для загрузки фото нужно авторизоваться"})]}),e.jsxs(P,{variant:"hero",size:"lg",className:"gap-2",onClick:()=>n("/profile"),children:[e.jsx(he,{className:"w-5 h-5"}),"Войти"]})]})})]})}export{ns as default};
