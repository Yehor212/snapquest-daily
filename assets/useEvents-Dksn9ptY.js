import{_ as u,y as r,$ as f,a0 as _,a1 as g,a2 as h}from"./index-X3YY-C0S.js";function m(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";for(let n=0;n<6;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}async function y(e,t,n,a){if(!u)return null;const{data:{user:i}}=await r.auth.getUser();if(!i)return null;const s=m(),{data:o,error:l}=await r.from("events").insert({name:e,description:n,access_code:s,creator_id:i.id,event_type:t,status:"active"}).select().single();if(l)return console.error("Error creating event:",l),null;if(await r.from("event_participants").insert({event_id:o.id,user_id:i.id}),a&&a.length>0){const v=a.map((d,p)=>({event_id:o.id,title:d.title,description:d.description,order_num:p,xp_reward:d.xpReward||30}));await r.from("event_challenges").insert(v)}return o}async function w(){if(!u)return[];const{data:{user:e}}=await r.auth.getUser();if(!e)return[];const{data:t}=await r.from("event_participants").select("event_id").eq("user_id",e.id),n=(t==null?void 0:t.map(s=>s.event_id))||[];let a=[];if(n.length===0){const{data:s}=await r.from("events").select("*").eq("creator_id",e.id).order("created_at",{ascending:!1});a=s||[]}else{const{data:s,error:o}=await r.from("events").select("*").in("id",n).order("created_at",{ascending:!1});if(o)return console.error("Error fetching events:",o),[];a=s||[]}return await Promise.all(a.map(async s=>{const[o,l]=await Promise.all([r.from("event_participants").select("*",{count:"exact",head:!0}).eq("event_id",s.id),r.from("event_challenges").select("*",{count:"exact",head:!0}).eq("event_id",s.id)]);return{...s,participants_count:o.count||0,challenges_count:l.count||0}}))}async function E(e){if(!u)return null;const[t,n,a,i]=await Promise.all([r.from("events").select("*").eq("id",e).single(),r.from("event_challenges").select("*").eq("event_id",e).order("order_num"),r.from("event_participants").select("*, profiles(*)").eq("event_id",e),r.from("photos").select("*").eq("event_id",e).order("created_at",{ascending:!1})]);return t.error||!t.data?(console.error("Error fetching event:",t.error),null):{event:t.data,challenges:n.data||[],participants:a.data||[],photos:i.data||[]}}async function C(e){if(!u)return null;const{data:{user:t}}=await r.auth.getUser();if(!t)return null;const{data:n,error:a}=await r.rpc("join_event_by_code",{code:e.toUpperCase()});if(a)return console.error("Error joining event:",a),null;if(!n)return console.error("Event not found or inactive"),null;const{data:i,error:s}=await r.from("events").select("*").eq("id",n).single();return s||!i?(console.error("Error fetching event after join:",s),null):i}const c={all:["events"],user:()=>[...c.all,"user"],detail:e=>[...c.all,"detail",e],participants:e=>[...c.all,"participants",e]};function R(){return f({queryKey:c.user(),queryFn:w,staleTime:5*60*1e3})}function U(e){return f({queryKey:c.detail(e||""),queryFn:()=>E(e),enabled:!!e,staleTime:60*1e3})}function b(){const e=_();return g({mutationFn:({name:t,eventType:n,description:a,challenges:i})=>y(t,n,a,i),onSuccess:()=>{e.invalidateQueries({queryKey:c.user()}),h()}})}export{U as a,b,C as j,R as u};
