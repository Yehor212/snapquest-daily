import{_ as u,v as n,$ as f,a0 as v,a1 as p}from"./index-BQQ8k2S_.js";function g(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";for(let r=0;r<6;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}async function y(e,t,r,s){if(!u)return null;const{data:{user:a}}=await n.auth.getUser();if(!a)return null;const o=g(),{data:c,error:l}=await n.from("events").insert({name:e,description:r,access_code:o,creator_id:a.id,event_type:t,status:"active"}).select().single();if(l)return console.error("Error creating event:",l),null;if(await n.from("event_participants").insert({event_id:c.id,user_id:a.id}),s&&s.length>0){const _=s.map((d,m)=>({event_id:c.id,title:d.title,description:d.description,order_num:m,xp_reward:30}));await n.from("event_challenges").insert(_)}return c}async function h(){if(!u)return[];const{data:{user:e}}=await n.auth.getUser();if(!e)return[];const{data:t}=await n.from("event_participants").select("event_id").eq("user_id",e.id),r=(t==null?void 0:t.map(o=>o.event_id))||[];if(r.length===0){const{data:o}=await n.from("events").select("*").eq("creator_id",e.id).order("created_at",{ascending:!1});return o||[]}const{data:s,error:a}=await n.from("events").select("*").in("id",r).order("created_at",{ascending:!1});return a?(console.error("Error fetching events:",a),[]):s||[]}async function q(e){if(!u)return null;const[t,r,s,a]=await Promise.all([n.from("events").select("*").eq("id",e).single(),n.from("event_challenges").select("*").eq("event_id",e).order("order_num"),n.from("event_participants").select("*, profiles(*)").eq("event_id",e),n.from("photos").select("*").eq("event_id",e).order("created_at",{ascending:!1})]);return t.error||!t.data?(console.error("Error fetching event:",t.error),null):{event:t.data,challenges:r.data||[],participants:s.data||[],photos:a.data||[]}}async function E(e){if(!u)return null;const{data:{user:t}}=await n.auth.getUser();if(!t)return null;const{data:r,error:s}=await n.from("events").select("*").eq("access_code",e.toUpperCase()).eq("status","active").single();if(s||!r)return console.error("Event not found:",s),null;const{error:a}=await n.from("event_participants").insert({event_id:r.id,user_id:t.id});return a&&a.code!=="23505"?(console.error("Error joining event:",a),null):r}const i={all:["events"],user:()=>[...i.all,"user"],detail:e=>[...i.all,"detail",e],participants:e=>[...i.all,"participants",e]};function C(){return f({queryKey:i.user(),queryFn:h,staleTime:5*60*1e3})}function K(e){return f({queryKey:i.detail(e||""),queryFn:()=>q(e),enabled:!!e,staleTime:60*1e3})}function U(){const e=v();return p({mutationFn:({name:t,eventType:r,description:s,challenges:a})=>y(t,r,s,a),onSuccess:()=>{e.invalidateQueries({queryKey:i.user()})}})}function Q(){const e=v();return p({mutationFn:t=>E(t),onSuccess:t=>{t&&(e.invalidateQueries({queryKey:i.user()}),e.invalidateQueries({queryKey:i.detail(t.id)}))}})}export{C as a,K as b,U as c,E as j,Q as u};
